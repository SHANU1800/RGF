<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluff - RITGAMES</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1000px;
            padding: 25px;
            min-height: 80vh;
        }
        .game-header { text-align: center; margin-bottom: 15px; }
        .game-header h1 { font-size: 2em; color: #2c3e50; }
        .room-info {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px;
        }
        .connection-status { padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        
        .lobby-screen { text-align: center; }
        .players-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .player-item { background: #2c3e50; color: white; padding: 10px 20px; border-radius: 10px; }
        
        .btn {
            padding: 12px 30px; border: none; border-radius: 8px;
            font-size: 1em; font-weight: bold; cursor: pointer; margin: 5px;
        }
        .btn-primary { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }

        .game-screen { display: none; }
        
        .other-players {
            display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;
            padding: 15px; background: #f0f0f0; border-radius: 10px; margin-bottom: 15px;
        }
        .other-player { text-align: center; padding: 10px; }
        .other-player .name { font-weight: bold; margin-bottom: 5px; }
        .other-player .card-count { 
            background: #2c3e50; color: white; padding: 8px 15px; border-radius: 8px;
        }
        .other-player.current-turn { background: #fff3cd; border-radius: 10px; }
        .other-player.out { opacity: 0.4; }
        
        .center-pile {
            text-align: center; padding: 20px; background: #27ae60; border-radius: 15px;
            margin: 15px 0; color: white;
        }
        .pile-info { font-size: 1.3em; margin-bottom: 10px; }
        .pile-count { font-size: 2em; font-weight: bold; }
        .last-claim { font-size: 1.1em; margin-top: 10px; font-style: italic; }
        
        .action-buttons { text-align: center; margin: 15px 0; }
        
        .my-hand {
            display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
            padding: 20px; background: #ecf0f1; border-radius: 15px;
        }
        
        .card {
            width: 60px; height: 85px; border-radius: 8px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; transition: all 0.2s; border: 2px solid #333;
            background: white;
        }
        .card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .card.selected { transform: translateY(-15px); box-shadow: 0 15px 25px rgba(0,0,0,0.3); border-color: #e74c3c; }
        .card .rank { font-size: 1.4em; }
        .card .suit { font-size: 1.2em; }
        .card.red { color: #e74c3c; }
        .card.black { color: #2c3e50; }
        
        .claim-section {
            display: none; text-align: center; padding: 15px;
            background: #fff3cd; border-radius: 10px; margin: 15px 0;
        }
        .claim-section.active { display: block; }
        .claim-section h3 { margin-bottom: 10px; }
        .rank-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .rank-btn {
            padding: 10px 20px; border: 2px solid #2c3e50; background: white;
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em;
        }
        .rank-btn:hover { background: #2c3e50; color: white; }
        .rank-btn.selected { background: #e74c3c; color: white; border-color: #e74c3c; }
        
        .game-status {
            text-align: center; padding: 12px; border-radius: 10px;
            font-size: 1.1em; font-weight: bold; margin: 10px 0;
        }
        .status-your-turn { background: #d4edda; color: #155724; }
        .status-waiting { background: #fff3cd; color: #856404; }
        
        .game-log {
            max-height: 100px; overflow-y: auto; background: #f8f9fa;
            padding: 10px; border-radius: 8px; font-size: 0.9em; margin: 10px 0;
        }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #ddd; }
        .log-entry.bluff-called { color: #e74c3c; font-weight: bold; }
        
        .hidden { display: none !important; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>üé≠ Bluff (Cheat)</h1>
        </div>
        <div class="room-info">
            <div class="room-code">Room: <span id="roomCodeDisplay">---</span></div>
            <div class="connection-status status-disconnected" id="connectionStatus">Connecting...</div>
        </div>

        <div class="lobby-screen" id="lobbyScreen">
            <h2>Waiting for Players...</h2>
            <div class="players-list" id="playersList"></div>
            <p id="playerCount">0 / 6 Players</p>
            <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" disabled>Start Game</button>
            <button class="btn btn-secondary" onclick="leaveRoom()">Leave Room</button>
        </div>

        <div class="game-screen" id="gameScreen">
            <div class="other-players" id="otherPlayers"></div>
            
            <div class="center-pile" id="centerPile">
                <div class="pile-info">Center Pile</div>
                <div class="pile-count"><span id="pileCount">0</span> cards</div>
                <div class="last-claim" id="lastClaim">No cards played yet</div>
            </div>
            
            <div class="game-status" id="gameStatus">Waiting...</div>
            
            <div class="action-buttons" id="actionButtons">
                <button class="btn btn-danger" onclick="callBluff()" id="callBluffBtn" style="display:none;">
                    üö® Call Bluff!
                </button>
            </div>
            
            <div class="claim-section" id="claimSection">
                <h3>Select rank to claim:</h3>
                <div class="rank-buttons" id="rankButtons"></div>
                <button class="btn btn-success" onclick="submitPlay()" id="submitBtn" disabled style="margin-top: 15px;">
                    Play Selected Cards
                </button>
            </div>
            
            <div class="game-log" id="gameLog"></div>
            
            <p style="text-align: center; margin: 10px 0; color: #666;">Select cards from your hand:</p>
            <div class="my-hand" id="myHand"></div>
            
            <div id="gameOverSection" class="hidden" style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
                <button class="btn btn-secondary" onclick="leaveRoom()">Leave Room</button>
            </div>
        </div>

        <div class="error-message hidden" id="errorMessage"></div>
    </div>

    <script>
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let heartbeatTimer = null;
        let shouldReconnect = true;
        let gameState = {
            roomCode: null, playerId: null, nickname: null,
            myHand: [], pileCount: 0, currentTurn: null,
            players: [], lastClaim: null, selectedCards: [],
            claimedRank: null, currentRank: null
        };

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            gameState.roomCode = urlParams.get('code');
            if (!gameState.roomCode) { showError('No room code provided'); return; }
            document.getElementById('roomCodeDisplay').textContent = gameState.roomCode;

            const roomData = JSON.parse(localStorage.getItem(`room_${gameState.roomCode}`) || '{}');
            gameState.playerId = roomData.member_id;
            gameState.nickname = roomData.nickname || 'Player';
            if (!gameState.playerId) { showError('Player data not found. Please join from dashboard.'); return; }
            
            renderRankButtons();
            connectWebSocket();
        }

        function renderRankButtons() {
            document.getElementById('rankButtons').innerHTML = RANKS.map(r => 
                `<div class="rank-btn" onclick="selectRank('${r}')">${r}</div>`
            ).join('');
        }

        function getWsBaseUrl() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsHost = window.location.port === '3000' ? 'localhost:8000' : window.location.host;
            return `${wsProtocol}//${wsHost}`;
        }

        function startHeartbeat() {
            stopHeartbeat();
            heartbeatTimer = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                }
            }, 5000);
        }

        function stopHeartbeat() {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
        }

        function scheduleReconnect() {
            if (!shouldReconnect) return;
            if (reconnectAttempts >= maxReconnectAttempts) return;
            const delay = 1000 * Math.pow(2, reconnectAttempts);
            reconnectAttempts += 1;
            setTimeout(connectWebSocket, delay);
        }

        function connectWebSocket() {
            if (!shouldReconnect) return;
            const wsUrl = `${getWsBaseUrl()}/ws/bluff/${gameState.roomCode}/`;
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                startHeartbeat();
                ws.send(JSON.stringify({ type: 'join', nickname: gameState.nickname, player_id: gameState.playerId }));
            };
            ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
            ws.onerror = () => showError('Connection error');
            ws.onclose = () => {
                stopHeartbeat();
                updateConnectionStatus(false);
                scheduleReconnect();
            };
        }

        function handleMessage(data) {
            console.log('Received:', data);
            switch(data.type) {
                case 'lobby_update': updateLobby(data.lobby_state); break;
                case 'game_start': startGameScreen(data); break;
                case 'game_state': updateGameState(data); break;
                case 'cards_played': onCardsPlayed(data); break;
                case 'bluff_called': onBluffCalled(data); break;
                case 'game_over': onGameOver(data); break;
                case 'error': showError(data.message); break;
            }
        }

        function updateLobby(lobby) {
            gameState.players = lobby.players;
            document.getElementById('playersList').innerHTML = lobby.players.map(p => 
                `<div class="player-item">${p.nickname}</div>`
            ).join('');
            document.getElementById('playerCount').textContent = `${lobby.player_count} / ${lobby.max_players} Players`;
            document.getElementById('startGameBtn').disabled = lobby.player_count < 1;
        }

        function startGame() { ws.send(JSON.stringify({ type: 'start_game' })); }

        function startGameScreen(data) {
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            updateGameState(data);
        }

        function updateGameState(data) {
            if (data.hand) gameState.myHand = data.hand;
            if (data.pile_count !== undefined) gameState.pileCount = data.pile_count;
            if (data.current_turn !== undefined) gameState.currentTurn = data.current_turn;
            if (data.players) gameState.players = data.players;
            if (data.last_claim) gameState.lastClaim = data.last_claim;
            if (data.current_rank) gameState.currentRank = data.current_rank;
            
            gameState.selectedCards = [];
            gameState.claimedRank = null;
            renderGame();
        }

        function renderGame() {
            renderOtherPlayers();
            renderCenterPile();
            renderMyHand();
            updateStatus();
            updateActionButtons();
        }

        function renderOtherPlayers() {
            const others = gameState.players.filter(p => p.id !== gameState.playerId);
            document.getElementById('otherPlayers').innerHTML = others.map(p => `
                <div class="other-player ${gameState.currentTurn === p.id ? 'current-turn' : ''} ${p.card_count === 0 ? 'out' : ''}">
                    <div class="name">${p.nickname}</div>
                    <div class="card-count">${p.card_count} cards</div>
                </div>
            `).join('');
        }

        function renderCenterPile() {
            document.getElementById('pileCount').textContent = gameState.pileCount;
            if (gameState.lastClaim) {
                document.getElementById('lastClaim').textContent = 
                    `Last: ${gameState.lastClaim.count}x ${gameState.lastClaim.rank} by ${gameState.lastClaim.player}`;
            }
        }

        function renderMyHand() {
            gameState.myHand.sort((a, b) => {
                const rankOrder = RANKS.indexOf(a.rank) - RANKS.indexOf(b.rank);
                if (rankOrder !== 0) return rankOrder;
                return SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit);
            });
            
            document.getElementById('myHand').innerHTML = gameState.myHand.map((card, i) => {
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                const isSelected = gameState.selectedCards.includes(i);
                return `<div class="card ${isRed ? 'red' : 'black'} ${isSelected ? 'selected' : ''}" 
                    onclick="toggleCard(${i})">
                    <span class="rank">${card.rank}</span>
                    <span class="suit">${card.suit}</span>
                </div>`;
            }).join('');
        }

        function updateStatus() {
            const isMyTurn = gameState.currentTurn === gameState.playerId;
            const statusEl = document.getElementById('gameStatus');
            if (isMyTurn) {
                statusEl.textContent = "Your Turn - Select cards and claim a rank!";
                statusEl.className = 'game-status status-your-turn';
            } else {
                const current = gameState.players.find(p => p.id === gameState.currentTurn);
                statusEl.textContent = `${current?.nickname || 'Someone'}'s turn`;
                statusEl.className = 'game-status status-waiting';
            }
        }

        function updateActionButtons() {
            const isMyTurn = gameState.currentTurn === gameState.playerId;
            document.getElementById('claimSection').classList.toggle('active', isMyTurn);
            document.getElementById('callBluffBtn').style.display = 
                (!isMyTurn && gameState.lastClaim && gameState.pileCount > 0) ? 'inline-block' : 'none';
        }

        function toggleCard(index) {
            const pos = gameState.selectedCards.indexOf(index);
            if (pos === -1) {
                gameState.selectedCards.push(index);
            } else {
                gameState.selectedCards.splice(pos, 1);
            }
            renderMyHand();
            updateSubmitButton();
        }

        function selectRank(rank) {
            gameState.claimedRank = rank;
            document.querySelectorAll('.rank-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent === rank);
            });
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const canSubmit = gameState.selectedCards.length > 0 && gameState.claimedRank;
            document.getElementById('submitBtn').disabled = !canSubmit;
        }

        function submitPlay() {
            if (gameState.selectedCards.length === 0 || !gameState.claimedRank) return;
            ws.send(JSON.stringify({
                type: 'play_cards',
                card_indices: gameState.selectedCards,
                claimed_rank: gameState.claimedRank
            }));
        }

        function callBluff() {
            ws.send(JSON.stringify({ type: 'call_bluff' }));
        }

        function onCardsPlayed(data) {
            addLog(`${data.player_name} played ${data.count}x ${data.claimed_rank}`);
            updateGameState(data);
        }

        function onBluffCalled(data) {
            const msg = data.was_bluff 
                ? `üö® BLUFF! ${data.caller} caught ${data.bluffer} lying! ${data.bluffer} picks up ${data.pile_count} cards!`
                : `‚ùå Not a bluff! ${data.caller} picks up ${data.pile_count} cards!`;
            addLog(msg, true);
            updateGameState(data);
        }

        function addLog(msg, isBluff = false) {
            const log = document.getElementById('gameLog');
            log.innerHTML = `<div class="log-entry ${isBluff ? 'bluff-called' : ''}">${msg}</div>` + log.innerHTML;
        }

        function onGameOver(data) {
            const winner = gameState.players.find(p => p.id === data.winner_id);
            document.getElementById('gameStatus').textContent = 
                data.winner_id === gameState.playerId ? 'üéâ You Won!' : `${winner?.nickname} Wins!`;
            document.getElementById('gameOverSection').classList.remove('hidden');
            document.getElementById('claimSection').classList.remove('active');
        }

        function playAgain() { ws.send(JSON.stringify({ type: 'play_again' })); }
        function leaveRoom() { 
            shouldReconnect = false;
            stopHeartbeat();
            const returnPartyCode = localStorage.getItem('returnPartyCode');
            const roomCode = gameState.roomCode;
            if (roomCode) {
                localStorage.removeItem(`room_${roomCode}`);
            }
            if (ws) ws.close(); 
            if (returnPartyCode) {
                window.location.href = `dashboard.html?party=${returnPartyCode}`;
            } else {
                window.location.href = 'dashboard.html';
            }
        }
        function updateConnectionStatus(connected) {
            const el = document.getElementById('connectionStatus');
            el.textContent = connected ? 'Connected' : 'Disconnected';
            el.className = 'connection-status ' + (connected ? 'status-connected' : 'status-disconnected');
        }
        function showError(msg) { 
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
